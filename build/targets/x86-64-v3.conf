# xanadOS x86-64-v3 Build Target Configuration
# Modern CPU optimization for processors 2017+ (AVX2, BMI2, F16C, etc.)

# Architecture Configuration
CARCH="x86_64"
CHOST="x86_64-pc-linux-gnu"
MARCH="x86-64-v3"

# Compiler Optimization Flags
CPPFLAGS="-D_FORTIFY_SOURCE=2"
CFLAGS="-march=x86-64-v3 -mtune=generic -O2 -pipe -fno-plt -fexceptions \
        -Wp,-D_FORTIFY_SOURCE=2 -Wformat -Werror=format-security \
        -fstack-clash-protection -fcf-protection"
CXXFLAGS="$CFLAGS -Wp,-D_GLIBCXX_ASSERTIONS"
LDFLAGS="-Wl,-O1,--sort-common,--as-needed,-z,relro,-z,now"

# Link Time Optimization
LTOFLAGS="-flto=auto"
RUSTFLAGS="-C opt-level=2 -C target-cpu=x86-64-v3"

# Parallel Compilation
MAKEFLAGS="-j$(nproc)"

# Package Compression (optimized for x86-64-v3)
COMPRESSGZ=(pigz -c -f -n)
COMPRESSBZ2=(pbzip2 -c -f)
COMPRESSXZ=(xz -c -z - --threads=0)
COMPRESSLRZ=(lrzip -q)
COMPRESSLZO=(lzop -q)
COMPRESSZ=(compress -c -f)
COMPRESSLZ4=(lz4 -q)
COMPRESSLZ=(lzip -c -f)

# Package Extensions
PKGEXT='.pkg.tar.zst'
SRCEXT='.src.tar.gz'

# Build Environment
BUILDENV=(!distcc !color !ccache check !sign)
BUILDDIR=/tmp/makepkg

# Performance Optimizations
export CFLAGS="$CFLAGS"
export CXXFLAGS="$CXXFLAGS"
export LDFLAGS="$LDFLAGS"
export MAKEFLAGS="$MAKEFLAGS"

# Target Identification
BUILD_TARGET="x86-64-v3"
BUILD_DESCRIPTION="Modern CPU optimization (Intel Haswell+, AMD Excavator+)"
PERFORMANCE_GAIN="10-15% over generic x86_64"

# Gaming-Specific Optimizations
GAMING_CFLAGS="-march=x86-64-v3 -mtune=generic -O3 -pipe -fno-plt"
GAMING_LDFLAGS="-Wl,-O2,--sort-common,--as-needed,-z,relro,-z,now"

# CPU Feature Requirements
REQUIRED_FEATURES=(
    "avx2"      # Advanced Vector Extensions 2
    "bmi2"      # Bit Manipulation Instructions 2
    "f16c"      # 16-bit floating-point conversion
    "fma"       # Fused Multiply-Add
    "movbe"     # Move data after swapping bytes
    "xsave"     # Extended state save/restore
)

# Validation Command
VALIDATION_CMD="grep -E 'avx2|bmi2|f16c|fma' /proc/cpuinfo >/dev/null"

# ISO Build Modifications
ISO_KERNEL="linux-zen"  # Use Zen kernel (available in main repos)
# ISO_PACKAGES_EXTRA=""  # No extra package group needed
ISO_COMPRESSION="xz -9e --check=crc32"  # High compression for distribution
