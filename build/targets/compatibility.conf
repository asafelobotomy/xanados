# xanadOS Compatibility Build Target Configuration
# Broad compatibility for older systems and maximum compatibility

# Architecture Configuration
CARCH="x86_64"
CHOST="x86_64-pc-linux-gnu"
MARCH="x86-64"

# Conservative Compiler Optimization Flags
CPPFLAGS="-D_FORTIFY_SOURCE=2"
CFLAGS="-march=x86-64 -mtune=generic -O2 -pipe -fno-plt -fexceptions \
        -Wp,-D_FORTIFY_SOURCE=2 -Wformat -Werror=format-security \
        -fstack-clash-protection -fcf-protection"
CXXFLAGS="$CFLAGS -Wp,-D_GLIBCXX_ASSERTIONS"
LDFLAGS="-Wl,-O1,--sort-common,--as-needed,-z,relro,-z,now"

# Conservative Link Time Optimization
LTOFLAGS=""  # Disabled for compatibility
RUSTFLAGS="-C opt-level=2 -C target-cpu=x86-64"

# Moderate Parallel Compilation
MAKEFLAGS="-j$(($(nproc) / 2))"  # Use half cores for stability

# Package Compression (compatibility focused)
COMPRESSGZ=(gzip -c -f -n)
COMPRESSBZ2=(bzip2 -c -f)
COMPRESSXZ=(xz -c -z -)
COMPRESSLRZ=(lrzip -q)
COMPRESSLZO=(lzop -q)
COMPRESSZ=(compress -c -f)
COMPRESSLZ4=(lz4 -q)
COMPRESSLZ=(lzip -c -f)

# Package Extensions
PKGEXT='.pkg.tar.xz'  # Standard compression for compatibility
SRCEXT='.src.tar.gz'

# Build Environment
BUILDENV=(!distcc !color !ccache check !sign)
BUILDDIR=/tmp/makepkg

# Performance Optimizations (conservative)
export CFLAGS="$CFLAGS"
export CXXFLAGS="$CXXFLAGS"
export LDFLAGS="$LDFLAGS"
export MAKEFLAGS="$MAKEFLAGS"

# Target Identification
BUILD_TARGET="compatibility"
BUILD_DESCRIPTION="Maximum compatibility for older systems (2010+)"
PERFORMANCE_GAIN="Stable performance, broad hardware support"

# Gaming-Specific Optimizations (conservative)
GAMING_CFLAGS="-march=x86-64 -mtune=generic -O2 -pipe -fno-plt"
GAMING_LDFLAGS="-Wl,-O1,--sort-common,--as-needed,-z,relro,-z,now"

# CPU Feature Requirements (minimal)
REQUIRED_FEATURES=(
    "sse2"      # Streaming SIMD Extensions 2 (standard x86-64)
    "cx16"      # CMPXCHG16B instruction
    "lahf_lm"   # LAHF/SAHF in long mode
    "popcnt"    # Population count instruction
)

# Validation Command (always passes for x86-64)
VALIDATION_CMD="grep -E 'sse2|cx16|lahf_lm|popcnt' /proc/cpuinfo >/dev/null"

# ISO Build Modifications
ISO_KERNEL="linux-zen"  # Standard zen kernel for compatibility
ISO_PACKAGES_EXTRA="compatibility-packages"
ISO_COMPRESSION="xz -6"  # Balanced compression

# Compatibility Notes
COMPATIBILITY_NOTES="Supports all x86-64 systems from 2010+. Recommended for older hardware."
MINIMUM_YEAR="2010"
SUPPORTED_CPUS="Intel Core 2, AMD Phenom II and newer"
