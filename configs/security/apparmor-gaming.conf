# xanadOS AppArmor Gaming Profile Template - 2025 Security Update
# Balanced security for gaming applications following current best practices

#include <tunables/global>

# Steam profile template (updated for 2025)
profile steam /usr/lib/steam/steam flags=(attach_disconnected,mediate_deleted) {
  #include <abstractions/base>
  #include <abstractions/audio>
  #include <abstractions/X>
  #include <abstractions/wayland>
  #include <abstractions/opengl>
  #include <abstractions/dri-enumerate>
  #include <abstractions/vulkan>

  # Capabilities (minimal set for gaming)
  capability setuid,
  capability setgid,
  capability sys_ptrace,

  # Steam directories
  /usr/lib/steam/** rm,
  /home/*/.local/share/Steam/** rw,
  /home/*/.steam/** rw,

  # Game directories
  /home/*/Games/** rw,
  /opt/steam/** rw,

  # System access needed for games (minimal)
  /usr/share/hwdata/pci.ids r,
  /sys/devices/pci**/config r,
  /proc/version r,
  /proc/cpuinfo r,
  /proc/meminfo r,
  /proc/sys/kernel/random/boot_id r,

  # Network access for multiplayer (restricted)
  network inet dgram,
  network inet stream,
  network inet6 dgram,
  network inet6 stream,

  # Graphics and audio (secure access)
  /dev/dri/** rw,
  /dev/snd/** rw,
  /dev/input/js* rw,
  /dev/input/event* rw,
  /dev/uinput rw,

  # Temporary files (restricted)
  owner /tmp/** rw,
  owner /var/tmp/** rw,

  # Game execution (confined)
  /home/*/Games/**/* Px -> steam_game,
  /home/*/.local/share/Steam/steamapps/common/**/* Px -> steam_game,

  # Deny dangerous operations
  deny /boot/** rwlkmx,
  deny /sys/kernel/security/** rwlkmx,
  deny /proc/sys/kernel/core_pattern rwlkmx,
  deny /etc/passwd rwlkmx,
  deny /etc/shadow rwlkmx,
  deny mount,
  deny umount,
  deny pivot_root,
  deny ptrace,
  deny signal,
}

# Steam game execution profile (2025 hardened)
profile steam_game flags=(attach_disconnected,mediate_deleted) {
  #include <abstractions/base>
  #include <abstractions/audio>
  #include <abstractions/X>
  #include <abstractions/wayland>
  #include <abstractions/opengl>
  #include <abstractions/vulkan>

  # Game-specific capabilities (minimal)
  capability setuid,
  capability setgid,

  # Game files access
  /home/*/Games/** r,
  /home/*/.local/share/Steam/steamapps/common/** r,
  owner /home/*/.local/share/Steam/userdata/** rw,

  # System libraries (read-only)
  /usr/lib/** r,
  /lib/** r,
  /lib64/** r,

  # Device access for input/output
  /dev/dri/** rw,
  /dev/snd/** rw,
  /dev/input/** rw,

  # Network (if needed for multiplayer)
  network inet dgram,
  network inet stream,
  network inet6 dgram,
  network inet6 stream,

  # Deny sensitive operations
  deny /etc/passwd r,
  deny /etc/shadow r,
  deny /root/** rwlkmx,
  deny @{PROC}/sys/kernel/core_pattern rwlkmx,
  deny mount,
  deny umount,
  deny pivot_root,
}

# Wine/Lutris profile template (2025 security)
profile wine /usr/bin/wine* flags=(attach_disconnected,mediate_deleted) {
  #include <abstractions/base>
  #include <abstractions/audio>
  #include <abstractions/X>
  #include <abstractions/wayland>
  #include <abstractions/opengl>
  #include <abstractions/vulkan>

  # Wine capabilities
  capability setuid,
  capability setgid,
  capability sys_ptrace,

  # Wine directories
  /usr/share/wine/** r,
  /usr/lib/wine/** rm,
  owner /home/*/.wine/** rw,
  owner /home/*/.local/share/wineprefixes/** rw,

  # System access (minimal)
  /proc/version r,
  /proc/cpuinfo r,
  /proc/meminfo r,
  /sys/devices/system/cpu/** r,

  # Graphics and audio
  /dev/dri/** rw,
  /dev/snd/** rw,
  /dev/input/** rw,

  # Network access
  network inet dgram,
  network inet stream,
  network inet6 dgram,
  network inet6 stream,

  # Deny system modification
  deny /etc/passwd rwlkmx,
  deny /etc/shadow rwlkmx,
  deny /boot/** rwlkmx,
  deny mount,
  deny umount,
  deny pivot_root,
}
  #include <abstractions/X>
  #include <abstractions/opengl>

  # Wine directories
  /opt/wine-stable/** rm,
  /home/*/.wine/** rw,
  /home/*/Games/** rw,

  # Windows compatibility
  /proc/version r,
  /proc/cpuinfo r,
  /proc/meminfo r,
  /sys/devices/system/cpu/cpu*/cache/index*/size r,

  # Graphics
  /dev/dri/** rw,
  /usr/share/libdrm/amdgpu.ids r,

  # Network
  network inet dgram,
  network inet stream,

  # Execute permissions
  /home/*/Games/**/* rix,
  /tmp/**/* rix,
}

# General gaming application profile
profile xanados-gaming {
  #include <abstractions/base>
  #include <abstractions/audio>
  #include <abstractions/X>
  #include <abstractions/opengl>
  #include <abstractions/dri-enumerate>

  # Basic system access
  /proc/version r,
  /proc/cpuinfo r,
  /proc/meminfo r,
  /sys/devices/system/cpu/** r,

  # Graphics access
  /dev/dri/** rw,
  /sys/class/drm/** r,

  # Audio access
  /dev/snd/** rw,

  # Input devices
  /dev/input/** rw,

  # Network access
  network inet dgram,
  network inet stream,

  # User directories
  owner /home/*/** rw,

  # Temporary files
  /tmp/** rw,
  /var/tmp/** rw,
}
