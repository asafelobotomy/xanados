# xanadOS Bubblewrap Gaming Sandbox Configuration - 2025 Security Standard
# Modern application sandboxing with minimal attack surface

# Gaming applications sandbox script
# Usage: bwrap_game [application] [args...]

# Base sandbox configuration for gaming applications
BWRAP_BASE_ARGS=(
    # Create new namespaces
    --unshare-all
    --share-net
    --new-session

    # Root filesystem (read-only)
    --ro-bind /usr /usr
    --ro-bind /lib /lib
    --ro-bind /lib64 /lib64
    --ro-bind /bin /bin
    --ro-bind /sbin /sbin
    --ro-bind /etc/passwd /etc/passwd
    --ro-bind /etc/group /etc/group
    --ro-bind /etc/ld.so.cache /etc/ld.so.cache
    --ro-bind /etc/ld.so.conf /etc/ld.so.conf
    --ro-bind /etc/ld.so.conf.d /etc/ld.so.conf.d
    --ro-bind /etc/resolv.conf /etc/resolv.conf
    --ro-bind /etc/hosts /etc/hosts
    --ro-bind /etc/localtime /etc/localtime
    --ro-bind /etc/machine-id /etc/machine-id

    # Essential directories
    --tmpfs /tmp
    --tmpfs /var/tmp
    --proc /proc
    --dev /dev
    --bind /sys /sys

    # Audio and graphics
    --ro-bind-try /run/user/$(id -u)/pulse /run/user/$(id -u)/pulse
    --bind-try /dev/dri /dev/dri
    --bind-try /dev/snd /dev/snd
    --bind-try /dev/input /dev/input

    # X11 and Wayland support
    --bind-try /tmp/.X11-unix /tmp/.X11-unix
    --bind-try /run/user/$(id -u)/wayland-0 /run/user/$(id -u)/wayland-0
    --setenv DISPLAY "$DISPLAY"
    --setenv WAYLAND_DISPLAY "$WAYLAND_DISPLAY"

    # Working directory
    --chdir /home/user
)

# Steam-specific sandbox
BWRAP_STEAM_ARGS=(
    "${BWRAP_BASE_ARGS[@]}"

    # Steam directories
    --bind "${HOME}/.local/share/Steam" "${HOME}/.local/share/Steam"
    --bind "${HOME}/.steam" "${HOME}/.steam"
    --bind-try "${HOME}/Games" "${HOME}/Games"

    # Additional Steam requirements
    --ro-bind /usr/share/hwdata /usr/share/hwdata
    --ro-bind /usr/share/vulkan /usr/share/vulkan
    --ro-bind /usr/share/glvnd /usr/share/glvnd

    # Graphics drivers
    --ro-bind-try /usr/lib/nvidia /usr/lib/nvidia
    --ro-bind-try /usr/lib32/nvidia /usr/lib32/nvidia
    --ro-bind-try /usr/lib/mesa /usr/lib/mesa
    --ro-bind-try /usr/lib32/mesa /usr/lib32/mesa

    # Allow network for Steam client and multiplayer
    --share-net

    # Restrict capabilities
    --cap-drop ALL
)

# Wine/Lutris sandbox
BWRAP_WINE_ARGS=(
    "${BWRAP_BASE_ARGS[@]}"

    # Wine prefixes
    --bind "${HOME}/.wine" "${HOME}/.wine"
    --bind-try "${HOME}/.local/share/wineprefixes" "${HOME}/.local/share/wineprefixes"
    --bind-try "${HOME}/Games" "${HOME}/Games"

    # Wine-specific libraries
    --ro-bind /usr/share/wine /usr/share/wine
    --ro-bind /usr/lib/wine /usr/lib/wine
    --ro-bind-try /usr/lib32/wine /usr/lib32/wine

    # Windows compatibility
    --ro-bind-try /usr/share/fonts /usr/share/fonts
    --ro-bind-try /usr/share/ca-certificates /usr/share/ca-certificates

    # Network access for some Windows games
    --share-net

    # Restrict capabilities
    --cap-drop ALL
)

# Discord sandbox (for gaming communication)
BWRAP_DISCORD_ARGS=(
    "${BWRAP_BASE_ARGS[@]}"

    # Discord configuration
    --bind "${HOME}/.config/discord" "${HOME}/.config/discord"
    --bind-try "${HOME}/.config/BetterDiscord" "${HOME}/.config/BetterDiscord"

    # Downloads directory for file sharing
    --bind "${HOME}/Downloads" "${HOME}/Downloads"

    # Camera and microphone (optional)
    --bind-try /dev/video0 /dev/video0

    # Network required
    --share-net

    # Minimal capabilities
    --cap-drop ALL
)

# Gaming browser sandbox (for web games)
BWRAP_BROWSER_ARGS=(
    "${BWRAP_BASE_ARGS[@]}"

    # Browser profile directory
    --bind "${HOME}/.config/chromium" "${HOME}/.config/chromium"
    --bind "${HOME}/Downloads" "${HOME}/Downloads"

    # Hardware acceleration
    --bind-try /dev/dri /dev/dri

    # Network access
    --share-net

    # Restricted capabilities
    --cap-drop ALL
    --new-session
)

# Security policies
SECURITY_POLICIES=(
    # Block access to sensitive directories
    --bind /dev/null /etc/shadow
    --bind /dev/null /etc/sudoers
    --bind /dev/null /etc/passwd-
    --bind /dev/null /etc/group-

    # Block system modification capabilities
    --cap-drop CAP_SYS_ADMIN
    --cap-drop CAP_SYS_MODULE
    --cap-drop CAP_SYS_RAWIO
    --cap-drop CAP_SYS_BOOT
    --cap-drop CAP_SYS_TIME
    --cap-drop CAP_MAC_ADMIN
    --cap-drop CAP_MAC_OVERRIDE

    # Restrict network namespaces
    --unshare-user
    --unshare-ipc
    --unshare-pid
    --unshare-uts
    --unshare-cgroup

    # Die with parent process
    --die-with-parent
)

# Example usage functions
bwrap_steam() {
    exec bwrap "${BWRAP_STEAM_ARGS[@]}" "${SECURITY_POLICIES[@]}" /usr/bin/steam "$@"
}

bwrap_wine() {
    exec bwrap "${BWRAP_WINE_ARGS[@]}" "${SECURITY_POLICIES[@]}" /usr/bin/wine "$@"
}

bwrap_discord() {
    exec bwrap "${BWRAP_DISCORD_ARGS[@]}" "${SECURITY_POLICIES[@]}" /usr/bin/discord "$@"
}

bwrap_lutris() {
    exec bwrap "${BWRAP_WINE_ARGS[@]}" "${SECURITY_POLICIES[@]}" /usr/bin/lutris "$@"
}

# Notes:
# - Bubblewrap provides namespacing without SUID privileges
# - Each application runs in isolated namespace
# - Network access controlled per application
# - Filesystem access strictly limited to necessary directories
# - All dangerous capabilities dropped by default
# - Follows principle of least privilege for 2025 security standards
